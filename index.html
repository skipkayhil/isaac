<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Isaac</title>

    <script type="importmap">
      {
        "imports": {
          "preact": "https://esm.sh/preact@10.23.1",
          "preact/": "https://esm.sh/preact@10.23.1/",
          "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact"
        }
      }
    </script>
  </head>
  <body>
    <div id="app"></div>

    <script type="module">
      import { render } from "preact";
      import { useEffect, useState } from "preact/hooks";
      import { html } from "htm/preact";

      const alphabet =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";

      const toQuery = (checkedIdStrings) => {
        let allChecked = new Array(642);

        checkedIdStrings
          .map((id) => parseInt(id))
          .forEach((i) => (allChecked[i] = true));

        let encodedString = "";

        for (let i = 0; i < 642; ) {
          let encodedIndex = 0;

          for (let j = 5; j >= 0; j--) {
            if (allChecked[i]) {
              encodedIndex |= 1 << j;
            }

            i++;
          }

          encodedString += alphabet[encodedIndex];
        }

        return encodedString;
      };

      const fromQuery = (query) => {
        if (query.length != 107) {
          return [];
        }

        let checkedIds = [];

        for (let i = 0; i < 107; i++) {
          const bits = alphabet
            .indexOf(query[i])
            .toString(2)
            .split("")
            .reverse();

          for (let j = 0; j < 6; j++) {
            if ("1" === bits[5 - j]) {
              checkedIds.push((i * 6 + j).toString());
            }
          }
        }

        return checkedIds;
      };

      const getCheckedFromQuery = () => {
        const url = new URL(window.location);
        const q = url.searchParams.get("q");

        return q ? fromQuery(q) : [];
      };

      const setCheckedQuery = (checkedIdStrings) => {
        const url = new URL(window.location);
        url.searchParams.set("q", toQuery(checkedIdStrings));
        history.pushState(null, "", url);
      };

      const Item = ({ item, type, toggleChecked }) => {
        const checked = type === "checked";
        const locked = type === "locked";

        const labelStyle = checked
          ? "text-decoration: line-through"
          : locked
            ? "opacity: 50%"
            : "";

        return html`
          <label style=${labelStyle}>
            ${item.name} | ${item.requirements}
            <input
              type="checkbox"
              onClick=${toggleChecked}
              checked=${checked}
              disabled=${locked}
            />
          </label>
        `;
      };

      const ItemSection = ({ items, toggle, type }) => html`
        <ul>
          ${Object.values(items)
            .toSorted((a, b) => a.id - b.id)
            .map(
              (item) => html`
                <li>
                  <${Item}
                    item=${item}
                    type=${type}
                    toggleChecked=${toggle(item, type === "checked")}
                  />
                </li>
              `,
            )}
        </ul>
      `;

      export function App() {
        const [data, setData] = useState({
          checked: [],
          unlocked: [],
          locked: [],
        });

        const processNewUnchecked = (newData, unchecked) =>
          Object.values(unchecked).forEach((item) => {
            for (const req of item.prereqs) {
              if (!newData.checked[req]) {
                newData.locked[item.name] = item;

                return;
              }
            }

            newData.unlocked[item.name] = item;
          });

        useEffect(() => {
          fetch("./achievements.json").then((resp) =>
            resp.json().then((d) => {
              let newData = { checked: {}, unlocked: {}, locked: {} };

              const checkedFromQuery = getCheckedFromQuery()
                .map((id) => parseInt(id) - 1)
                .sort((a, b) => a - b)
                .reverse();

              for (const i of checkedFromQuery) {
                const checkedItem = d.splice(i, 1)[0];

                newData.checked[checkedItem.name] = checkedItem;
              }

              processNewUnchecked(newData, d);

              setData(newData);
            }),
          );
        }, []);

        const toggleItemChecked = (item, wasChecked) => () => {
          let newData = {
            checked: { ...data.checked },
            unlocked: {},
            locked: {},
          };

          let unchecked = {
            ...data.unlocked,
            ...data.locked,
          };

          if (wasChecked) {
            const sameReqItems = Object.values(newData.checked).filter(
              (i) => i["requirements"] === item.requirements,
            );

            for (const i of sameReqItems) {
              delete newData.checked[i.name];

              unchecked[i.name] = i;
            }
          } else {
            const sameReqItems = Object.values(unchecked).filter(
              (i) => i["requirements"] === item.requirements,
            );

            for (const i of sameReqItems) {
              delete unchecked[i.name];

              newData.checked[i.name] = i;
            }
          }

          processNewUnchecked(newData, unchecked);

          setCheckedQuery(
            Object.values(newData.checked)
              .map((i) => i.id)
              .sort(),
          );
          setData(newData);
        };

        return html`
          Isaac

          <${ItemSection}
            type="checked"
            items=${data.checked}
            toggle=${toggleItemChecked}
          />
          <${ItemSection}
            type="unlocked"
            items=${data.unlocked}
            toggle=${toggleItemChecked}
          />
          <${ItemSection}
            type="locked"
            items=${data.locked}
            toggle=${toggleItemChecked}
          />
        `;
      }

      render(html`<${App} />`, document.getElementById("app"));
    </script>
  </body>
</html>
